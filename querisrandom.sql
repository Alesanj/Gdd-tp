USE GD1C2023
GO

SELECT *
FROM sys.objects
WHERE type IN ('FN', 'IF', 'TF') 

SELECT *
FROM sys.procedures

EXEC borrar_todo

exec crear_tablas
exec migrar_tablas

SELECT * FROM NEW_MODEL.ALTA

SELECT DISTINCT PRODUCTO_LOCAL_CODIGO, PRODUCTO_LOCAL_NOMBRE, PRODUCTO_LOCAL_DESCRIPCION, PRODUCTO_LOCAL_PRECIO,PRODUCTO_CANTIDAD FROM gd_esquema.Maestra
        WHERE PRODUCTO_LOCAL_CODIGO IS NOT NULL

		SELECT DISTINCT PRODUCTO_LOCAL_CODIGO FROM gd_esquema.Maestra
        WHERE PRODUCTO_LOCAL_CODIGO IS NOT NULL

		SELECT DISTINCT PRODUCTO_LOCAL_CODIGO, PRODUCTO_LOCAL_DESCRIPCION FROM gd_esquema.Maestra WHERE PRODUCTO_LOCAL_CODIGO IS NOT NULL 
SELECT * FROM gd_esquema.Maestra WHERE PRODUCTO_LOCAL_CODIGO IS NOT NULL ORDER BY PRODUCTO_LOCAL_CODIGO

SELECT * FROM NEW_MODEL.PRODUCTO
SELECT * FROM NEW_MODEL.[LOCAL]
SELECT * FROM NEW_MODEL.HORARIO
SELECT HORARIO_NRO, LOCAL_NOMBRE, DIA_NOMBRE, HORARIO_LOCAL_HORA_APERTURA, HORARIO_LOCAL_HORA_CIERRE FROM NEW_MODEL.HORARIO JOIN NEW_MODEL.[LOCAL] ON LOCAL_NRO = HORARIO_LOCAL_NRO JOIN NEW_MODEL.DIA ON DIA_NRO = HORARIO_DIA_NRO 
order by LOCAL_NOMBRE 


exec crear_tablas

select * from NEW_MODEL.DIA
SELECT DISTINCT dbo.obtenerLocalNro(LOCAL_NOMBRE,LOCAL_DIRECCION) AS HORARIO_LOCAL_NRO, dbo.obtenerDiaNro(HORARIO_LOCAL_DIA) AS HORARIO_LOCAL_DIA, HORARIO_LOCAL_HORA_APERTURA,HORARIO_LOCAL_HORA_CIERRE
FROM gd_esquema.Maestra WHERE LOCAL_NOMBRE IS NOT NULL 


SELECT DISTINCT LOCAL_NOMBRE, LOCAL_DIRECCION, HORARIO_LOCAL_DIA,HORARIO_LOCAL_HORA_APERTURA,HORARIO_LOCAL_HORA_CIERRE 
FROM gd_esquema.Maestra WHERE LOCAL_NOMBRE IS NOT NULL 

PRINT (dbo.obtenerLocalNro('Local nÂ° 1','Avenida Independencia2874'))
PRINT (dbo.obtenerDiaNro('Domingo'))

 SELECT DISTINCT dbo.obtenerTipoLocalNro(LOCAL_TIPO),dbo.obtenerLocalidadNro(LOCAL_PROVINCIA,LOCAL_LOCALIDAD), LOCAL_NOMBRE, LOCAL_DESCRIPCION, LOCAL_DIRECCION
FROM gd_esquema.Maestra WHERE LOCAL_NOMBRE IS NOT NULL 

SELECT * FROM NEW_MODEL.[LOCAL] ORDER BY LOCAL_NOMBRE
SELECT * FROM NEW_MODEL.[PRODUCTO]


exec crear_tablas
EXEC migrar_tablas

SELECT * FROM gd_esquema.Maestra

select * FROM gd_esquema.Maestra WHERE PEDIDO_NRO IS NOT NULL order by PEDIDO_NRO

		SELECT DISTINCT PEDIDO_NRO, REPARTIDOR_DNI, DIRECCION_USUARIO_NOMBRE,DIRECCION_USUARIO_DIRECCION,PEDIDO_PRECIO_ENVIO,PEDIDO_TARIFA_SERVICIO,PEDIDO_PROPINA FROM gd_esquema.Maestra
		WHERE PEDIDO_PRECIO_ENVIO IS NOT NULL

		SELECT DISTINCT PEDIDO_NRO FROM gd_esquema.Maestra
		WHERE PEDIDO_PRECIO_ENVIO IS NOT NULL

		SELECT * FROM gd_esquema.Maestra WHERE pedido_nro is not null order by pedido_nro


		SELECT PE.PEDIDO_ENVIO_NRO, RE.REPARTIDOR_DNI, DIR.DIRECCION_USUARIO_NOMBRE, PE.PEDIDO_ENVIO_PRECIO, PE.PEDIDO_ENVIO_TARIFA_SERVICIO FROM NEW_MODEL.PEDIDO_ENVIO PE  JOIN NEW_MODEL.REPARTIDOR RE ON PEDIDO_ENVIO_REPARTIDOR_NRO = REPARTIDOR_NRO JOIN NEW_MODEL.DIRECCION_USUARIO DIR ON PEDIDO_ENVIO_DIRECCION_USUARIO_NRO = DIRECCION_USUARIO_NRO

EXEC crear_tablas
exec migrar_tablas

SELECT * FROM NEW_MODEL.PRODUCTO
SELECT * FROM NEW_MODEL.PEDIDO_ENVIO

SELECT DISTINCT PRODUCTO_LOCAL_CODIGO,LOCAL_NOMBRE, LOCAL_DIRECCION FROM gd_esquema.Maestra where PRODUCTO_LOCAL_CODIGO IS NOT NULL ORDER BY LOCAL_NOMBRE
SELECT DISTINCT LOCAL_NOMBRE, LOCAL_DIRECCION FROM gd_esquema.Maestra
SELECT DISTINCT PRODUCTO_LOCAL_CODIGO FROM gd_esquema.Maestra

SELECT * FROM NEW_MODEL.LOCAL_PRODUCTO
select LOCAL_NOMBRE, PRODUCTO_NOMBRE from NEW_MODEL.LOCAL_PRODUCTO JOIN NEW_MODEL.LOCAL ON LOCAL_PRODUCTO_LOCAL_NRO = LOCAL_NRO JOIN NEW_MODEL.PRODUCTO ON LOCAL_PRODUCTO_PRODUCTO_NRO = PRDUCTO_NRO
exec borrar_todo

EXEC crear_tablas
exec migrar_tablas


SELECT DISTINCT LOCAL_NOMBRE, LOCAL_DIRECCION PRODUCTO_LOCAL_CODIGO FROM gd_esquema.Maestra where PRODUCTO_LOCAL_CODIGO IS NOT NULL 
ORDER BY LOCAL_NOMBRE

SELECT DISTINCT REPARTIDOR_DNI, LOCAL_NOMBRE, LOCAL_LOCALIDAD, PEDIDO_NRO FROM gd_esquema.Maestra WHERE REPARTIDOR_DNI IS NOT NULL ORDER BY  REPARTIDOR_DNI, LOCAL_NOMBRE
SELECT DISTINCT REPARTIDOR_DNI, LOCAL_NOMBRE, ENVIO_MENSAJERIA_LOCALIDAD, ENVIO_MENSAJERIA_NRO FROM gd_esquema.Maestra WHERE REPARTIDOR_DNI IS NOT NULL ORDER BY  REPARTIDOR_DNI, LOCAL_NOMBRE

SELECT DISTINCT REPARTIDOR_DNI, LOCAL_NOMBRE, LOCAL_LOCALIDAD, ENVIO_MENSAJERIA_LOCALIDAD FROM gd_esquema.Maestra WHERE REPARTIDOR_DNI IS NOT NULL ORDER BY  REPARTIDOR_DNI, LOCAL_NOMBRE

-- ESTA CONSULTA NOS DEVUELVE UNA ESPECIE "HISTORIAL", DE LAS LOCALIDADES DONDE ESTUVO TRABAJANDO EL REPARTIDOR, YA SEA POR PEDIDO O POR ENVIO, "LA MAS ACTUAL" ACTUAL DEBERIA SER LA LOCALIDAD ACTIVA, EL RESTO NO
-- PODEMOS USAR LA FECHA O FECHA DE ENTREGA COMO ULTIMO LUGAR DONDE ESTUVO EL REPARTIDOR

SELECT DISTINCT PEDIDO_NRO, REPARTIDOR_DNI, LOCAL_NOMBRE, LOCAL_LOCALIDAD, PEDIDO_FECHA ,PEDIDO_FECHA_ENTREGA FROM gd_esquema.Maestra WHERE REPARTIDOR_DNI IS NOT NULL ORDER BY  REPARTIDOR_DNI, LOCAL_NOMBRE

SELECT DISTINCT PEDIDO_NRO, REPARTIDOR_DNI, PEDIDO_FECHA, PEDIDO_FECHA_ENTREGA FROM gd_esquema.Maestra WHERE PEDIDO_NRO IS NOT NULL ORDER BY  PEDIDO_FECHA DESC
-- ESTA FUNCION NOS  ORDENA LOS PEDIDOS POR FECHA EN ORDEN DESCENDENTE Y SELECCIONANDO EL PRIMERO OBTENEMOS EL MAS ACTUAL 

SELECT * FROM(
SELECT DISTINCT PEDIDO_NRO AS NRO_OP,LOCAL_PROVINCIA AS PROVINCIA, LOCAL_LOCALIDAD AS LOCALIDAD, REPARTIDOR_DNI, PEDIDO_FECHA AS FECHA FROM gd_esquema.Maestra WHERE PEDIDO_NRO IS NOT NULL
UNION 
SELECT DISTINCT ENVIO_MENSAJERIA_NRO AS NRO_OP, ENVIO_MENSAJERIA_PROVINCIA AS PROVINCIA, ENVIO_MENSAJERIA_LOCALIDAD AS LOCALIDAD, REPARTIDOR_DNI, ENVIO_MENSAJERIA_FECHA AS FECHA FROM gd_esquema.Maestra WHERE ENVIO_MENSAJERIA_NRO IS NOT NULL
) T WHERE T.REPARTIDOR_DNI = 1295290
ORDER BY FECHA DESC 

SELECT * FROM NEW_MODEL.ALTA

-- ESTE UNION NOS DA LOS ENVIOS + LOS PEDIDOS CON SUS FECHAS, TODOS EN UNA SOLA TABLA, SI ORDENAMOS POR DESC OBTENDREMOS LA MAS ACTUAL


CREATE TABLE #temp (
    REPARTIDOR_DNI nvarchar(255),
    LOCALIDAD nvarchar(255),
)

insert into #temp (REPARTIDOR_DNI,LOCALIDAD)
SELECT DISTINCT REPARTIDOR_DNI, LOCAL_LOCALIDAD AS LOCALIDAD FROM gd_esquema.Maestra WHERE PEDIDO_NRO IS NOT NULL
UNION
SELECT DISTINCT REPARTIDOR_DNI, ENVIO_MENSAJERIA_LOCALIDAD AS LOCALIDAD FROM gd_esquema.Maestra WHERE ENVIO_MENSAJERIA_NRO IS NOT NULL

select * from NEW_MODEL.USUARIO
SELECT * FROM #temp
SELECT DISTINCT * FROM #temp

DROP TABLE #temp

SELECT * FROM NEW_MODEL.LOCALIDAD

SELECT DISTINCT ENVIO_MENSAJERIA_NRO FROM gd_esquema.Maestra ORDER BY ENVIO_MENSAJERIA_NRO

SELECT * FROM gd_esquema.Maestra

SELECT DISTINCT
                dbo.obtenerRepartidorNro(REPARTIDOR_DNI) as REPARTIDOR_DNI
            FROM
                gd_esquema.Maestra
            WHER

select distinct ENVIO_MENSAJERIA_ESTADO from gd_esquema.Maestra

CREATE FUNCTION obtenerEnvioPedido(@envioPrecio decimal(18,0), @envioTarifa decimal(18,0)) RETURNS int 
AS
    BEGIN
        DECLARE @envioPedidoNro int;
        SELECT @envioPedidoNro = PEDIDO_ENVIO_NRO FROM NEW_MODEL.PEDIDO_ENVIO WHERE PEDIDO_ENVIO_PRECIO = @envioPrecio  AND PEDIDO_ENVIO_TARIFA_SERVICIO = @envioTarifa ;
        RETURN @envioPedidoNro;
    END
GO

